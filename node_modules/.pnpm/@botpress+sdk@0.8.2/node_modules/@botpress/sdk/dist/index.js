"use strict";var ee=Object.create;var S=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var ne=Object.getOwnPropertyNames;var oe=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var k=(t,e)=>{for(var n in e)S(t,n,{get:e[n],enumerable:!0})},x=(t,e,n,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ne(e))!se.call(t,s)&&s!==n&&S(t,s,{get:()=>e[s],enumerable:!(a=te(e,s))||a.enumerable});return t},p=(t,e,n)=>(x(t,e,"default"),n&&x(n,e,"default")),j=(t,e,n)=>(n=t!=null?ee(oe(t)):{},x(e||!t||!t.__esModule?S(n,"default",{value:t,enumerable:!0}):n,t)),re=t=>x(S({},"__esModule",{value:!0}),t);var T={};k(T,{Bot:()=>U,BotSpecificClient:()=>y,Integration:()=>M,IntegrationDefinition:()=>P,IntegrationSpecificClient:()=>I,botIdHeader:()=>b,botUserIdHeader:()=>D,configurationHeader:()=>v,integrationIdHeader:()=>O,messages:()=>A,operationHeader:()=>B,parseBody:()=>u,serve:()=>C,studioComponentDefinitions:()=>_,typeHeader:()=>R,webhookIdHeader:()=>H,z:()=>o.z});module.exports=re(T);var A={};k(A,{defaults:()=>me});var g={};k(g,{default:()=>ae,studioComponentDefinitions:()=>_,z:()=>o.z});var o=require("@bpinternal/zui");p(g,require("@bpinternal/zui"));var d=o.z.object({allowDynamicVariable:o.z.boolean().optional(),horizontal:o.z.boolean().optional()}),_={string:{textInput:{id:"textInput",params:d.extend({multiLine:o.z.boolean().optional(),growVertically:o.z.boolean().optional(),suggestions:o.z.array(o.z.string()).optional()})},dropdown:{id:"dropdown",params:d.extend({filterable:o.z.boolean().optional()})},radiogroup:{id:"radiogroup",params:d.extend({})},datepicker:{id:"datepicker",params:d.extend({dateFormat:o.z.string().optional(),minDate:o.z.string().optional(),maxDate:o.z.string().optional(),defaultTimezone:o.z.string().optional(),disableTimezoneSelection:o.z.boolean().optional(),highlightCurrentDay:o.z.boolean().optional(),showShortcutButtons:o.z.boolean().optional(),showOutsideDaysOfMonth:o.z.boolean().optional(),firstDayOfWeek:o.z.number().optional(),canChangeMonth:o.z.boolean().optional(),showWeekNumbers:o.z.boolean().optional()})},timepicker:{id:"timepicker",params:d.extend({useAMPM:o.z.boolean().optional(),timeFormat:o.z.string().optional(),minTime:o.z.string().optional(),maxTime:o.z.string().optional(),showArrowButtons:o.z.boolean().optional(),precision:o.z.enum(["minute","second","millisecond"]).optional()})},variablepicker:{id:"variablepicker",params:o.z.object({type:o.z.enum(["any","string","number","boolean","object","pattern","date","array","target","time","enum"]),horizontal:o.z.boolean().optional()})},richTextEditor:{id:"richTextEditor",params:o.z.object({allowDynamicVariable:o.z.boolean().optional(),resizable:o.z.boolean().optional()})},JSONInput:{id:"JSONInput",params:d.extend({showPreview:o.z.boolean().optional(),showValidationError:o.z.boolean().optional()})},fileInput:{id:"fileInput",params:d.extend({fileTypes:o.z.array(o.z.enum(["image","audio","video"])).optional(),showUploadedFiles:o.z.boolean().optional()})}},number:{numberInput:{id:"numberInput",params:d.extend({allowNumericCharactersOnly:o.z.boolean().optional(),stepSize:o.z.number().optional()})},slider:{id:"slider",params:o.z.object({horizontal:o.z.boolean().optional(),stepSize:o.z.number().optional()})}},boolean:{switch:{id:"switch",params:d}},array:{optionList:{id:"optionList",params:d},stringList:{id:"stringList",params:d}},object:{collapsible:{id:"collapsible",params:o.z.object({defaultOpen:o.z.boolean().optional()})}}},ae=o.z;var c=o.z.string().min(1),ie=o.z.object({text:c}),ge=o.z.object({markdown:c}),ce=o.z.object({imageUrl:c}),pe=o.z.object({audioUrl:c}),le=o.z.object({videoUrl:c}),de=o.z.object({fileUrl:c,title:c.optional()}),ue=o.z.object({latitude:o.z.number(),longitude:o.z.number(),address:o.z.string().optional(),title:o.z.string().optional()}),q=o.z.object({title:c,subtitle:c.optional(),imageUrl:c.optional(),actions:o.z.array(o.z.object({action:o.z.enum(["postback","url","say"]),label:c,value:c}))}),K=o.z.object({text:c,options:o.z.array(o.z.object({label:c,value:c}))}),Te=o.z.object({items:o.z.array(q)}),me={text:{schema:ie},markdown:{schema:ge},image:{schema:ce},audio:{schema:pe},video:{schema:le},file:{schema:de},location:{schema:ue},carousel:{schema:Te},card:{schema:q},dropdown:{schema:K},choice:{schema:K}};var b="x-bot-id",D="x-bot-user-id",O="x-integration-id",H="x-webhook-id",v="x-bp-configuration",B="x-bp-operation",R="x-bp-type";var z=require("node:http");var h=console;function u(t){if(!t.body)throw new Error("Missing body");return JSON.parse(t.body)}async function C(t,e=8072,n=fe){let a=(0,z.createServer)(async(s,r)=>{try{let i=await he(s);if(i.path==="/health"){r.writeHead(200).end("ok");return}let l=await t(i);r.writeHead(l?.status??200,l?.headers??{}).end(l?.body??"{}")}catch(i){h.error("Error while handling request",{error:i?.message??"Internal error occured"}),r.writeHead(500).end(JSON.stringify({error:i?.message??"Internal error occured"}))}});return a.listen(e,()=>n(e)),a}async function he(t){let e=await ye(t),n={};for(let s=0;s<t.rawHeaders.length;s+=2){let r=t.rawHeaders[s].toLowerCase(),i=t.rawHeaders[s+1];n[r]=i}let a=new URL(t.url??"",t.headers.host?`http://${t.headers.host}`:"http://botpress.cloud");return{body:e,path:a.pathname,query:Ie(a.search,"?"),headers:n,method:t.method?.toUpperCase()??"GET"}}function Ie(t,e){return t.indexOf(e)===0?t.slice(e.length):t}async function ye(t){return new Promise((e,n)=>{if(t.method!=="POST"&&t.method!=="PUT"&&t.method!=="PATCH")return e(void 0);let a="";t.on("data",s=>a+=s.toString()),t.on("error",s=>n(s)),t.on("end",()=>e(a))})}function fe(t){h.info(`Listening on port ${t}`)}p(T,g,module.exports);var N=require("@bpinternal/zui");var be=N.z.enum(["webhook_received","message_created","action_triggered","register","unregister","ping","create_user","create_conversation"]),$=t=>{let e=t[b],n=t[D],a=t[O],s=t[H],r=t[v],i=be.parse(t[B]);if(!e)throw new Error("Missing bot headers");if(!n)throw new Error("Missing bot user headers");if(!a)throw new Error("Missing integration headers");if(!s)throw new Error("Missing webhook headers");if(!r)throw new Error("Missing configuration headers");if(!i)throw new Error("Missing operation headers");return{botId:e,botUserId:n,integrationId:a,webhookId:s,operation:i,configuration:r?JSON.parse(Buffer.from(r,"base64").toString("utf-8")):{}}};var P=class{constructor(e){this.props=e;this.name=e.name,this.version=e.version,this.icon=e.icon,this.readme=e.readme,this.title=e.title,this.identifier=e.identifier,this.description=e.description,this.configuration=e.configuration,this.events=e.events,this.actions=e.actions,this.channels=e.channels,this.states=e.states,this.user=e.user,this.secrets=e.secrets,this.entities=e.entities}name;version;title;description;icon;readme;configuration;events;actions;channels;states;user;secrets;identifier;entities};var w=require("@botpress/client");var I=class{constructor(e){this.client=e}createConversation=e=>this.client.createConversation(e);getConversation=e=>this.client.getConversation(e);listConversations=e=>this.client.listConversations(e);getOrCreateConversation=e=>this.client.getOrCreateConversation(e);updateConversation=e=>this.client.updateConversation(e);deleteConversation=e=>this.client.deleteConversation(e);listParticipants=e=>this.client.listParticipants(e);addParticipant=e=>this.client.addParticipant(e);getParticipant=e=>this.client.getParticipant(e);removeParticipant=e=>this.client.removeParticipant(e);createEvent=e=>this.client.createEvent(e);getEvent=e=>this.client.getEvent(e);listEvents=e=>this.client.listEvents(e);createMessage=e=>this.client.createMessage(e);getOrCreateMessage=e=>this.client.getOrCreateMessage(e);getMessage=e=>this.client.getMessage(e);updateMessage=e=>this.client.updateMessage(e);listMessages=e=>this.client.listMessages(e);deleteMessage=e=>this.client.deleteMessage(e);createUser=e=>this.client.createUser(e);getUser=e=>this.client.getUser(e);listUsers=e=>this.client.listUsers(e);getOrCreateUser=e=>this.client.getOrCreateUser(e);updateUser=e=>this.client.updateUser(e);deleteUser=e=>this.client.deleteUser(e);getState=e=>this.client.getState(e);setState=e=>this.client.setState(e);getOrSetState=e=>this.client.getOrSetState(e);patchState=e=>this.client.patchState(e);configureIntegration=e=>this.client.configureIntegration(e)};var F=j(require("util")),E=t=>{if(process.env.BP_LOG_FORMAT==="json")return JSON.stringify({msg:F.default.format(...t),visible_to_bot_owner:!0});{let[e,...n]=t;return F.default.format(`[For Bot Owner] ${e}`,...n)}},W={forBot:()=>({info:(...t)=>{console.info(E(t))},warn:(...t)=>{console.warn(E(t))},error:(...t)=>{console.error(E(t))},debug:(...t)=>{console.debug(E(t))}})};var Z=t=>async e=>{let n=$(e.headers),a=new I(new w.Client({botId:n.botId,integrationId:n.integrationId})),s={ctx:n,req:e,client:a,logger:W,instance:t};try{let r;switch(n.operation){case"webhook_received":r=await Be(s);break;case"register":r=await Ce(s);break;case"unregister":r=await xe(s);break;case"message_created":r=await Ee(s);break;case"action_triggered":r=await we(s);break;case"ping":r=await ve(s);break;case"create_user":r=await Se(s);break;case"create_conversation":r=await Pe(s);break;default:throw new Error(`Unknown operation ${n.operation}`)}return r?{...r,status:r.status??200}:{status:200}}catch(r){if(r instanceof w.RuntimeError)return{status:r.code,body:JSON.stringify(r.toJSON())};throw r}},ve=async t=>{},Be=async({client:t,ctx:e,req:n,logger:a,instance:s})=>{let{req:r}=u(n);return s.webhook({client:t,ctx:e,req:r,logger:a})},Ce=async({client:t,ctx:e,req:n,logger:a,instance:s})=>{if(!s.register)return;let{webhookUrl:r}=u(n);await s.register({client:t,ctx:e,webhookUrl:r,logger:a})},xe=async({client:t,ctx:e,req:n,logger:a,instance:s})=>{if(!s.unregister)return;let{webhookUrl:r}=u(n);await s.unregister({ctx:e,webhookUrl:r,client:t,logger:a})},Se=async({client:t,ctx:e,req:n,logger:a,instance:s})=>{if(!s.createUser)return;let{tags:r}=u(n);return await s.createUser({ctx:e,client:t,tags:r,logger:a})},Pe=async({client:t,ctx:e,req:n,logger:a,instance:s})=>{if(!s.createConversation)return;let{channel:r,tags:i}=u(n);return await s.createConversation({ctx:e,client:t,channel:r,tags:i,logger:a})},Ee=async({ctx:t,req:e,client:n,logger:a,instance:s})=>{let{conversation:r,user:i,type:l,payload:f,message:m}=u(e),G=s.channels[r.channel];if(!G)throw new Error(`Channel ${r.channel} not found`);let L=G.messages[l];if(!L)throw new Error(`Message of type ${l} not found in channel ${r.channel}`);await L({ctx:t,conversation:r,message:m,user:i,type:l,client:n,payload:f,ack:async({tags:Y})=>{await n.updateMessage({id:m.id,tags:Y})},logger:a})},we=async({req:t,ctx:e,client:n,logger:a,instance:s})=>{let{input:r,type:i}=u(t);if(!i)throw new Error("Missing action type");let l=s.actions[i];if(!l)throw new Error(`Action ${i} not found`);let f=await l({ctx:e,input:r,client:n,type:i,logger:a});return{body:JSON.stringify({output:f})}};var M=class{props;actions;channels;register;unregister;createUser;createConversation;webhook;constructor(e){this.props=e,this.actions=e.actions,this.channels=e.channels,this.register=e.register,this.unregister=e.unregister,this.createUser=e.createUser,this.createConversation=e.createConversation,this.webhook=e.handler}handler=Z(this);start=e=>C(this.handler,e)};var Q=j(require("@botpress/client"));var y=class{constructor(e){this.client=e}getConversation=e=>this.client.getConversation(e);listConversations=e=>this.client.listConversations(e);updateConversation=e=>this.client.updateConversation(e);deleteConversation=e=>this.client.deleteConversation(e);listParticipants=e=>this.client.listParticipants(e);addParticipant=e=>this.client.addParticipant(e);getParticipant=e=>this.client.getParticipant(e);removeParticipant=e=>this.client.removeParticipant(e);getEvent=e=>this.client.getEvent(e);listEvents=e=>this.client.listEvents(e);createMessage=e=>this.client.createMessage(e);getOrCreateMessage=e=>this.client.getOrCreateMessage(e);getMessage=e=>this.client.getMessage(e);updateMessage=e=>this.client.updateMessage(e);listMessages=e=>this.client.listMessages(e);deleteMessage=e=>this.client.deleteMessage(e);getUser=e=>this.client.getUser(e);listUsers=e=>this.client.listUsers(e);updateUser=e=>this.client.updateUser(e);deleteUser=e=>this.client.deleteUser(e);getState=e=>this.client.getState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));setState=e=>this.client.setState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));getOrSetState=e=>this.client.getOrSetState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));patchState=e=>this.client.patchState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));callAction=e=>this.client.callAction(e);createConversation=e=>this.client.createConversation(e);getOrCreateConversation=e=>this.client.getOrCreateConversation(e);createUser=e=>this.client.createUser(e);getOrCreateUser=e=>this.client.getOrCreateUser(e)};var J=require("@bpinternal/zui");var Me=J.z.enum(["event_received","register","unregister","ping","action_triggered"]),V=t=>{let e=t[b],n=t[v],a=t[R],s=Me.parse(t[B]);if(!e)throw new Error("Missing bot headers");if(!a)throw new Error("Missing type headers");if(!n)throw new Error("Missing configuration headers");if(!s)throw new Error("Missing operation headers");return{botId:e,operation:s,type:a,configuration:n?JSON.parse(Buffer.from(n,"base64").toString("utf-8")):{}}};var X=t=>async e=>{let n=V(e.headers);n.operation!=="ping"&&h.info(`Received ${n.operation} operation for bot ${n.botId} of type ${n.type}`);let a=new y(new Q.Client({botId:n.botId})),s={req:e,ctx:n,client:a,instance:t};switch(n.operation){case"action_triggered":throw new Error(`Operation ${n.operation} not supported yet`);case"event_received":await De(s);break;case"register":await ke(s);break;case"unregister":await Ae(s);break;case"ping":await Ue(s);break;default:throw new Error(`Unknown operation ${n.operation}`)}return{status:200}},Ue=async t=>{},ke=async t=>{},Ae=async t=>{},De=async({ctx:t,req:e,client:n,instance:a})=>{h.debug(`Received event ${t.type}`);let s=u(e),r=s.event;switch(t.type){case"message_created":let i={user:r.payload.user,conversation:r.payload.conversation,message:r.payload.message,states:r.payload.states,event:r};await Promise.all(a.messageHandlers.map(m=>m({client:n,ctx:t,...i})));break;case"state_expired":let l={state:r.payload.state};await Promise.all(a.stateExpiredHandlers.map(m=>m({client:n,ctx:t,...l})));break;default:let f={event:s.event};await Promise.all(a.eventHandlers.map(m=>m({client:n,ctx:t,...f})))}};var U=class{_state={messageHandlers:[],eventHandlers:[],stateExpiredHandlers:[]};props;constructor(e){this.props=e}message=e=>{this._state.messageHandlers.push(e)};event=e=>{this._state.eventHandlers.push(e)};stateExpired=e=>{this._state.stateExpiredHandlers.push(e)};handler=X(this._state);start=e=>C(this.handler,e)};0&&(module.exports={Bot,BotSpecificClient,Integration,IntegrationDefinition,IntegrationSpecificClient,botIdHeader,botUserIdHeader,configurationHeader,integrationIdHeader,messages,operationHeader,parseBody,serve,studioComponentDefinitions,typeHeader,webhookIdHeader,z});
//# sourceMappingURL=index.js.map
